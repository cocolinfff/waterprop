<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水物性计算器 | 核工程工具箱</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <style>
        body{font-family:"宋体",serif;margin:0;padding:10px;background:#c0c0c0;font-size:12px}
        .container{background:#f0f0f0;padding:10px;border:2px outset #c0c0c0;max-width:800px;margin:0 auto}
        h1{color:#000080;text-align:center;font-size:18px;margin:5px 0;text-shadow:1px 1px 2px #808080}
        .tabs{display:flex;margin-bottom:10px;border-bottom:2px solid #808080}
        .tab{padding:5px 15px;cursor:pointer;background:#d4d0c8;border:1px solid #808080;border-bottom:none;margin-right:2px;font-size:12px}
        .tab.active{background:#fff;font-weight:bold}
        .tab-content{display:none;background:#fff;border:1px solid #808080;padding:10px}
        .tab-content.active{display:block}
        label{display:block;margin-bottom:2px;font-weight:bold;color:#000080}
        select,input{width:200px;padding:2px;border:1px solid #808080;font-size:12px;font-family:"宋体",serif}
        button{background:#d4d0c8;color:#000;padding:5px 15px;border:2px outset #d4d0c8;cursor:pointer;font-size:12px;font-family:"宋体",serif;font-weight:bold}
        button:active{border:2px inset #d4d0c8}
        button:disabled{color:#808080;cursor:not-allowed}
        .result{margin-top:10px;padding:10px;background:#d4d0c8;border:1px solid #808080;font-size:11px}
        .error{background:#ffd4d4;border:1px solid #f00;color:#f00}
        .properties-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:5px;margin-top:8px}
        .property{background:#fff;padding:5px;border:1px solid #808080;font-size:11px}
        .property-name{font-weight:bold;color:#000080;margin-bottom:2px}
        .property-value{color:#000;font-family:"Courier New",monospace;word-wrap:break-word}
        .header{background:linear-gradient(to bottom,#000080,#4169e1);color:#fff;padding:5px;text-align:center;margin-bottom:10px;border:1px solid #808080}
        .status-bar{background:#d4d0c8;border:1px solid #808080;padding:3px 5px;margin-top:10px;font-size:11px;color:#000080}
        .input-row{display:flex;align-items:center;gap:5px;margin-bottom:5px}
        .input-row label{min-width:80px;margin-bottom:0}
        .unit-group{margin-bottom:20px;padding:15px;border:1px solid #808080;background:#f8f8f8}
        .unit-group label{font-weight:bold;color:#000080;margin-bottom:10px;display:block}
        .unit-converter{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
        .unit-select{width:200px;padding:3px;border:1px solid #808080;font-size:11px}
        .unit-input{width:120px;padding:3px;border:1px solid #808080;font-size:11px}
        .unit-converter span{font-weight:bold;color:#000080;font-size:14px}
        .unit-note{font-size:10px;color:#666;margin:5px 0 0 0;line-height:1.3}
        #unit h3{color:#000080;border-bottom:1px solid #808080;padding-bottom:3px;margin-top:20px}
        #unit h2{color:#000080;text-align:center;margin-bottom:15px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>物性计算器</h1>
            <div>基于 IAPWS-IF97 标准</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(event,'calculate')">物性计算</div>
            <div class="tab" onclick="switchTab(event,'export')">数据导出</div>
            <div class="tab" style="color:#0000cc;text-decoration:underline;" onclick="window.open('./data.html', '_blank')">材料物性</div>
            <div class="tab" style="color:#0000cc;text-decoration:underline;" onclick="window.open('./unit.html', '_blank')">单位换算</div>
        </div>
        
        <div id="calculate" class="tab-content active">
            <form id="calculateForm">
                <div class="input-row">
                    <label>输入参数1:</label>
                    <select id="input1_type" name="input1_type" tabindex="1">
                        <option value="T">温度 (°C)</option>
                        <option value="P">压力 (MPa)</option>
                        <option value="H">焓 (kJ/kg)</option>
                        <option value="Q">热力干度</option>
                    </select>
                    <input type="number" id="input1_value" name="input1_value" step="any" required tabindex="2">
                </div>
                <div class="input-row">
                    <label>输入参数2:</label>
                    <select id="input2_type" name="input2_type" tabindex="4">
                        <option value="P">压力 (MPa)</option>
                        <option value="T">温度 (°C)</option>
                        <option value="H">焓 (kJ/kg)</option>
                        <option value="Q">热力干度</option>
                    </select>
                    <input type="number" id="input2_value" name="input2_value" step="any" required tabindex="3">
                </div>
                <button type="submit" id="calculateButton" tabindex="5">计算物性</button>
            </form>
            <div id="calculateResult"></div>
        </div>
        
        <div id="export" class="tab-content">
            <h3>数据导出</h3>
            <p style="color:#666;margin-bottom:15px">生成二维参数表格数据</p>
            <div style="margin-bottom:15px">
                <label>参数1：</label>
                <select id="param1">
                    <option value="T">温度 (°C)</option>
                    <option value="P">压力 (MPa)</option>
                    <option value="H">焓 (kJ/kg)</option>
                    <option value="Q">热力干度</option>
                </select>
                <label>步数：</label>
                <input type="number" id="steps1" min="1" max="100" value="10" required onchange="toggleRangeInputs(1)" tabindex="1">
                <span id="range1">
                    <label>起始值：</label>
                    <input type="number" id="start1" step="any" required tabindex="2">
                    <label>结束值：</label>
                    <input type="number" id="end1" step="any" required tabindex="3">
                </span>
                <span id="single1" style="display:none">
                    <label>值：</label>
                    <input type="number" id="singleValue1" step="any" required tabindex="4">
                </span>
            </div>
            <div style="margin-bottom:15px">
                <label>参数2：</label>
                <select id="param2">
                    <option value="P" selected>压力 (MPa)</option>
                    <option value="T">温度 (°C)</option>
                    <option value="H">焓 (kJ/kg)</option>
                    <option value="Q">热力干度</option>
                </select>
                <label>步数：</label>
                <input type="number" id="steps2" min="1" max="100" value="1" required onchange="toggleRangeInputs(2)" tabindex="5">
                <span id="range2">
                    <label>起始值：</label>
                    <input type="number" id="start2" step="any" required tabindex="6">
                    <label>结束值：</label>
                    <input type="number" id="end2" step="any" required tabindex="7">
                </span>
                <span id="single2" style="display:none">
                    <label>值：</label>
                    <input type="number" id="singleValue2" step="any" required tabindex="8">
                </span>
            </div>
            <button id="exportButton" onclick="exportData()">导出CSV</button>
            <div id="exportResult"></div>
        </div>
        <div class="status-bar" id="statusBar">初始化...</div>
    </div>
    <script type="module">
const API_BASE_URL='https://water-func-iqweupkgxi.cn-shanghai.fcapp.run',FLUID='Water',statusBar=document.getElementById('statusBar'),calculateButton=document.getElementById('calculateButton'),exportButton=document.getElementById('exportButton'),calculateResultDiv=document.getElementById('calculateResult'),exportResultDiv=document.getElementById('exportResult');let coolprop=null,calculationMode='cloud';
window.switchTab=(e,t)=>{document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById(t).classList.add('active');e.currentTarget.classList.add('active')};
window.toggleRangeInputs=n=>{const s=parseInt(document.getElementById(`steps${n}`).value)===1;document.getElementById(`range${n}`).style.display=s?'none':'inline';document.getElementById(`single${n}`).style.display=s?'inline':'none'};
const propertyMap={T:{name:'温度',unit:'°C',toSI:v=>v+273.15,fromSI:v=>v-273.15,apiName:'temperature'},P:{name:'压力',unit:'MPa',toSI:v=>v*1e6,fromSI:v=>v/1e6,apiName:'pressure'},H:{name:'焓',unit:'kJ/kg',toSI:v=>v*1000,fromSI:v=>v/1000,apiName:'enthalpy'},S:{name:'熵',unit:'kJ/(kg·K)',fromSI:v=>v/1000,apiName:'entropy'},D:{name:'密度',unit:'kg/m³',fromSI:v=>v,apiName:'density'},Q:{name:'热力干度',unit:'',toSI:v=>v,fromSI:v=>v,apiName:'quality'},C:{name:'比热容',unit:'kJ/(kg·K)',fromSI:v=>v/1000,apiName:'specific_heat'},V:{name:'动力粘度',unit:'Pa·s',fromSI:v=>v,apiName:'viscosity'},L:{name:'导热系数',unit:'W/(m·K)',fromSI:v=>v,apiName:'thermal_conductivity'},I:{name:'表面张力',unit:'N/m',fromSI:v=>v,apiName:'surface_tension'},A:{name:'声速',unit:'m/s',fromSI:v=>v,apiName:'speed_of_sound'},TSAT:{name:'饱和温度',unit:'°C',fromSI:v=>v-273.15,apiName:'tsat'},PSAT:{name:'饱和压力',unit:'MPa',fromSI:v=>v/1e6,apiName:'psat'},HF:{name:'饱和液体焓',unit:'kJ/kg',fromSI:v=>v/1000,apiName:'hf'},HG:{name:'饱和蒸汽焓',unit:'kJ/kg',fromSI:v=>v/1000,apiName:'hg'},HFG:{name:'汽化潜热',unit:'kJ/kg',fromSI:v=>v/1000,apiName:'hfg'}};
function preprocessPQInputs(d){const isPQ=(d.input1_type==='P'&&d.input2_type==='Q')||(d.input1_type==='Q'&&d.input2_type==='P');if(!isPQ)return d;let pressure,quality,pVal,qVal;if(d.input1_type==='P'){pressure='input1';quality='input2';pVal=d.input1_value;qVal=d.input2_value}else{pressure='input2';quality='input1';pVal=d.input2_value;qVal=d.input1_value}let hVal;if(calculationMode==='local'&&coolprop){try{const pSI=propertyMap.P.toSI(pVal),hf=coolprop.PropsSI('H','P',pSI,'Q',0,FLUID),hg=coolprop.PropsSI('H','P',pSI,'Q',1,FLUID);hVal=propertyMap.H.fromSI(hf+qVal*(hg-hf))}catch(e){throw new Error('无法计算压力对应的饱和焓值')}}else return d;const newData={...d};if(pressure==='input1'){newData.input2_type='H';newData.input2_value=hVal}else{newData.input1_type='H';newData.input1_value=hVal}newData.originalQuality=qVal;return newData}
async function calculateViaAPI(d){const req={input1_type:propertyMap[d.input1_type].apiName,input1_value:d.input1_value,input2_type:propertyMap[d.input2_type].apiName,input2_value:d.input2_value},res=await fetch(`${API_BASE_URL}/calculate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(req)});if(!res.ok){const err=await res.json();throw new Error(err.error||`服务器错误 (状态: ${res.status})`)}const resData=await res.json(),data=Array.isArray(resData)?JSON.parse(resData[2]):resData;if(!data.success)throw new Error(data.error||'计算失败');const props={};for(const key in propertyMap){const apiName=propertyMap[key].apiName;if(data.properties[apiName]!==undefined&&data.properties[apiName]!=="N/A")props[key]=data.properties[apiName]}if(data.properties.saturation_data){const satData=data.properties.saturation_data;if(satData.tsat!==undefined)props.TSAT=satData.tsat;if(satData.psat!==undefined)props.PSAT=satData.psat;if(satData.hf!==undefined)props.HF=satData.hf;if(satData.hg!==undefined)props.HG=satData.hg;if(satData.hfg!==undefined)props.HFG=satData.hfg}if(d.originalQuality!==undefined)props.Q=d.originalQuality;return{success:true,properties:props}}
function calculateViaLocal(d){const procData=preprocessPQInputs(d),{input1_type:t1,input1_value:v1,input2_type:t2,input2_value:v2=0}=procData;try{const val1=propertyMap[t1].toSI(v1),val2=propertyMap[t2].toSI(v2),props={};Object.keys(propertyMap).forEach(k=>{if(['TSAT','PSAT','HF','HG','HFG'].includes(k)||k==='Q'&&(t1==='Q'||t2==='Q')||k==='I')return;try{const r=coolprop.PropsSI(k,t1,val1,t2,val2,FLUID);if(isFinite(r))props[k]=r}catch(e){}});if(t1==='Q')props.Q=v1;if(t2==='Q')props.Q=v2;if(procData.originalQuality!==undefined)props.Q=procData.originalQuality;const p=props.P||(t1==='P'?val1:t2==='P'?val2:null),temp=props.T||(t1==='T'?val1:t2==='T'?val2:null);try{if(temp&&temp<647.067){const st=coolprop.PropsSI('I','T',temp,'Q',0,FLUID);if(isFinite(st))props.I=st}}catch(e){}try{if(p&&p<22064000){const tsat=coolprop.PropsSI('T','P',p,'Q',0,FLUID),hf=coolprop.PropsSI('H','P',p,'Q',0,FLUID),hg=coolprop.PropsSI('H','P',p,'Q',1,FLUID),psat=coolprop.PropsSI('P','T',temp,'Q',0,FLUID);if(isFinite(tsat))props.TSAT=tsat;if(isFinite(hf))props.HF=hf;if(isFinite(hg))props.HG=hg;if(isFinite(hf)&&isFinite(hg))props.HFG=hg-hf;if(isFinite(psat))props.PSAT=psat}}catch(e){}return{success:true,properties:props}}catch(e){return{success:false,error:e.message}}}
document.getElementById('calculateForm').addEventListener('submit',async function(e){e.preventDefault();calculateResultDiv.innerHTML='';statusBar.textContent=`正在计算 (${calculationMode==='local'?'本地':'云端'})...`;statusBar.style.color='#000080';calculateButton.disabled=true;const data=new FormData(this),calcData={input1_type:data.get('input1_type'),input1_value:parseFloat(data.get('input1_value')),input2_type:data.get('input2_type'),input2_value:parseFloat(data.get('input2_value'))};try{const result=calculationMode==='local'?calculateViaLocal(calcData):await calculateViaAPI(calcData);if(result.success){displayResults(result.properties);statusBar.textContent='计算完成'}else throw new Error(result.error)}catch(error){calculateResultDiv.innerHTML=`<div class="result error"><h3>错误</h3><p>${error.message}</p></div>`;statusBar.textContent=`计算失败: ${error.message}`;statusBar.style.color='#f00'}finally{calculateButton.disabled=false}});
window.exportData=async()=>{exportResultDiv.innerHTML='';statusBar.textContent=`正在生成CSV (${calculationMode==='local'?'本地':'云端'})...`;statusBar.style.color='#000080';exportButton.disabled=true;try{const p1=document.getElementById('param1').value,s1=parseInt(document.getElementById('steps1').value),p2=document.getElementById('param2').value,s2=parseInt(document.getElementById('steps2').value);let st1,e1,st2,e2;if(s1===1)st1=e1=parseFloat(document.getElementById('singleValue1').value);else{st1=parseFloat(document.getElementById('start1').value);e1=parseFloat(document.getElementById('end1').value)}if(s2===1)st2=e2=parseFloat(document.getElementById('singleValue2').value);else{st2=parseFloat(document.getElementById('start2').value);e2=parseFloat(document.getElementById('end2').value)}if(isNaN(st1)||isNaN(e1)||isNaN(st2)||isNaN(e2))throw new Error('所有输入值必须是数字。');const csvContent=calculationMode==='local'?generateCsvLocal(p1,st1,e1,s1,p2,st2,e2,s2):await generateCsvAPI(p1,st1,e1,s1,p2,st2,e2,s2);downloadCsv(csvContent);exportResultDiv.innerHTML=`<div class="result"><h3>导出成功</h3><p>已生成 ${s1*s2} 个数据点的CSV文件</p></div>`;statusBar.textContent='导出完成'}catch(error){exportResultDiv.innerHTML=`<div class="result error"><h3>导出失败</h3><p>${error.message}</p></div>`;statusBar.textContent=`导出失败: ${error.message}`;statusBar.style.color='#f00'}finally{exportButton.disabled=false}};
function displayResults(props){let html='<div class="result"><h3>水物性参数</h3><div class="properties-grid">';const mainProps=['T','P','H','S','D','Q','C','V','L','I','A'];for(const key of mainProps){if(props[key]===undefined)continue;const propInfo=propertyMap[key],displayValue=propInfo.fromSI(props[key]),valueStr=(typeof displayValue==='number'&&key!=='Q')?displayValue.toPrecision(8):(key==='Q'&&displayValue>=0&&displayValue<=1)?displayValue.toFixed(4):(key==='I'&&displayValue>0)?displayValue.toPrecision(6):'N/A';if(valueStr==='N/A')continue;html+=`<div class="property"><div class="property-name">${propInfo.name}</div><div class="property-value">${valueStr} ${propInfo.unit}</div></div>`}html+='</div>';const satProps=['TSAT','PSAT','HF','HG','HFG'],hasSatData=satProps.some(key=>props[key]!==undefined);if(hasSatData){html+='<h3>饱和物性参数</h3><div class="properties-grid">';for(const key of satProps){if(props[key]===undefined)continue;const propInfo=propertyMap[key],displayValue=propInfo.fromSI(props[key]),valueStr=(typeof displayValue==='number')?displayValue.toPrecision(8):'N/A';if(valueStr==='N/A')continue;html+=`<div class="property"><div class="property-name">${propInfo.name}</div><div class="property-value">${valueStr} ${propInfo.unit}</div></div>`}html+='</div>'}html+='</div>';calculateResultDiv.innerHTML=html}
function generateCsvLocal(p1,st1,e1,s1,p2,st2,e2,s2){const v1=Array.from({length:s1},(i,x)=>st1+(e1-st1)*x/(s1>1?s1-1:1)),v2=Array.from({length:s2},(i,x)=>st2+(e2-st2)*x/(s2>1?s2-1:1)),headers=[propertyMap[p1].name,propertyMap[p2].name,...Object.values(propertyMap).map(m=>m.name)];let csv=headers.join(',')+'\n';for(const val1 of v1)for(const val2 of v2){const result=calculateViaLocal({input1_type:p1,input1_value:val1,input2_type:p2,input2_value:val2});const row=[val1,val2];if(result.success)for(const key in propertyMap)row.push(result.properties[key]!==undefined?propertyMap[key].fromSI(result.properties[key]):'');else row.push(...Array(Object.keys(propertyMap).length).fill('Error'));csv+=row.join(',')+'\n'}return csv}
async function generateCsvAPI(p1_type,p1_start,p1_end,p1_steps,p2_type,p2_start,p2_end,p2_steps){const requestData={param1:propertyMap[p1_type].apiName,start1:p1_start,end1:p1_end,steps1:p1_steps,param2:propertyMap[p2_type].apiName,start2:p2_start,end2:p2_end,steps2:p2_steps},response=await fetch(`${API_BASE_URL}/export_csv`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)});if(!response.ok){const errorData=await response.json();throw new Error(errorData.error||`服务器错误 (状态: ${response.status})`)}return await response.text()}
function downloadCsv(content){const blob=new Blob([content],{type:'text/csv;charset=utf-8;'}),link=document.createElement("a");link.href=URL.createObjectURL(blob);link.download=`water_properties_${new Date().toISOString().slice(0,10)}.csv`;document.body.appendChild(link);link.click();document.body.removeChild(link)}
function setupUnitConverters(){document.querySelectorAll('.unit-converter').forEach(converter=>{const inputs=converter.querySelectorAll('.unit-input'),selects=converter.querySelectorAll('.unit-select');inputs.forEach((input,index)=>{input.addEventListener('input',()=>{if(input.value!==''){const fromSelect=selects[index],toSelect=selects[1-index],otherInput=inputs[1-index],fromFactor=parseFloat(fromSelect.selectedOptions[0].dataset.factor),toFactor=parseFloat(toSelect.selectedOptions[0].dataset.factor),inputValue=parseFloat(input.value);if(!isNaN(inputValue)){const baseValue=inputValue*fromFactor,convertedValue=baseValue/toFactor;otherInput.value=convertedValue.toPrecision(6)}}else inputs[1-index].value=''})});selects.forEach((select,index)=>{select.addEventListener('change',()=>{const activeInput=inputs[index];if(activeInput.value!=='')activeInput.dispatchEvent(new Event('input'))})})})}
document.addEventListener('DOMContentLoaded',()=>{toggleRangeInputs(1);toggleRangeInputs(2);setupUnitConverters();statusBar.innerHTML='目前状态：云端计算。正在后台加载本地模块...';import('./coolprop.js').then(Module=>{Module.default({locateFile:(path,prefix)=>path.endsWith('.wasm')?'./coolprop.wasm':prefix+path}).then(instance=>{coolprop=instance;calculationMode='local';statusBar.textContent='本地计算模块已加载。'}).catch(e=>{console.error("WASM failed:",e);statusBar.innerHTML='本地模块加载失败，将继续使用云端计算。<span style="color:#f00">（奇迹和魔法可不是免费的）</span>';statusBar.style.color='#000080'})}).catch(e=>{console.error("JS Module load failed:",e);statusBar.innerHTML='无法加载本地计算脚本，将继续使用云端计算。<span style="color:#f00">（奇迹和魔法可不是免费的）</span>'})});
    </script>
</body>
