<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水物性计算器 v1.1</title>
    <style>
        body { font-family: "宋体", "SimSun", serif; margin: 0; padding: 10px; background-color: #c0c0c0; font-size: 12px; }
        .container { background: #f0f0f0; padding: 10px; border: 2px outset #c0c0c0; max-width: 800px; margin: 0 auto; }
        h1 { color: #000080; text-align: center; font-size: 18px; margin: 5px 0; text-shadow: 1px 1px 2px #808080; }
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 2px solid #808080; }
        .tab { padding: 5px 15px; cursor: pointer; background: #d4d0c8; border: 1px solid #808080; border-bottom: none; margin-right: 2px; font-size: 12px; }
        .tab.active { background: #ffffff; font-weight: bold; }
        .tab-content { display: none; background: #ffffff; border: 1px solid #808080; padding: 10px; }
        .tab-content.active { display: block; }
        label { display: block; margin-bottom: 2px; font-weight: bold; color: #000080; }
        select, input { width: 200px; padding: 2px; border: 1px solid #808080; font-size: 12px; font-family: "宋体", "SimSun", serif; }
        button { background: #d4d0c8; color: #000; padding: 5px 15px; border: 2px outset #d4d0c8; cursor: pointer; font-size: 12px; font-family: "宋体", "SimSun", serif; font-weight: bold; }
        button:active { border: 2px inset #d4d0c8; }
        button:disabled { color: #808080; cursor: not-allowed; }
        .result { margin-top: 10px; padding: 10px; background: #d4d0c8; border: 1px solid #808080; font-size: 11px; }
        .error { background: #ffd4d4; border: 1px solid #ff0000; color: #ff0000; }
        .properties-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px; margin-top: 8px; }
        .property { background: #ffffff; padding: 5px; border: 1px solid #808080; font-size: 11px; }
        .property-name { font-weight: bold; color: #000080; margin-bottom: 2px; }
        .property-value { color: #000; font-family: "Courier New", monospace; word-wrap: break-word; }
        .header { background: linear-gradient(to bottom, #000080, #4169e1); color: white; padding: 5px; text-align: center; margin-bottom: 10px; border: 1px solid #808080; }
        .status-bar { background: #d4d0c8; border: 1px solid #808080; padding: 3px 5px; margin-top: 10px; font-size: 11px; color: #000080; }
        .input-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .input-row label { min-width: 80px; margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>水物性计算器 v1.1</h1>
            <div>基于 IAPWS-IF97 标准</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'calculate')">物性计算</div>
            <div class="tab" onclick="switchTab(event, 'export')">数据导出</div>
        </div>
        
        <div id="calculate" class="tab-content active">
            <form id="calculateForm">
                <div class="input-row">
                    <label>输入参数1:</label>
                    <select id="input1_type" name="input1_type">
                        <option value="temperature">温度 (°C)</option>
                        <option value="pressure">压力 (MPa)</option>
                        <option value="enthalpy">焓 (kJ/kg)</option>
                        <option value="dryness">热力干度</option>
                    </select>
                    <input type="number" id="input1_value" name="input1_value" step="any" required>
                </div>
                
                <div class="input-row">
                    <label>输入参数2:</label>
                    <select id="input2_type" name="input2_type">
                        <option value="pressure">压力 (MPa)</option>
                        <option value="temperature">温度 (°C)</option>
                        <option value="enthalpy">焓 (kJ/kg)</option>
                        <option value="dryness">热力干度</option>
                    </select>
                    <input type="number" id="input2_value" name="input2_value" step="any" required>
                </div>
                
                <button type="submit" id="calculateButton">计算物性</button>
            </form>
            
            <div id="calculateResult"></div>
        </div>
        
        <div id="export" class="tab-content">
            <h3>数据导出</h3>
            <p style="color: #666; margin-bottom: 15px;">生成二维参数表格数据</p>
            
            <div style="margin-bottom: 15px;">
                <label>参数1：</label>
                <select id="param1">
                    <option value="temperature">温度 (°C)</option>
                    <option value="pressure">压力 (MPa)</option>
                    <option value="enthalpy">焓 (kJ/kg)</option>
                    <option value="dryness">热力干度</option>
                </select>
                <label>步数：</label>
                <input type="number" id="steps1" min="1" max="100" value="10" required onchange="toggleRangeInputs(1)">
                <span id="range1">
                    <label>起始值：</label>
                    <input type="number" id="start1" step="any" required>
                    <label>结束值：</label>
                    <input type="number" id="end1" step="any" required>
                </span>
                <span id="single1" style="display: none;">
                    <label>值：</label>
                    <input type="number" id="singleValue1" step="any" required>
                </span>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>参数2：</label>
                <select id="param2">
                    <option value="pressure" selected>压力 (MPa)</option>
                    <option value="temperature">温度 (°C)</option>
                    <option value="enthalpy">焓 (kJ/kg)</option>
                    <option value="dryness">热力干度</option>
                </select>
                <label>步数：</label>
                <input type="number" id="steps2" min="1" max="100" value="1" required onchange="toggleRangeInputs(2)">
                <span id="range2">
                    <label>起始值：</label>
                    <input type="number" id="start2" step="any" required>
                    <label>结束值：</label>
                    <input type="number" id="end2" step="any" required>
                </span>
                <span id="single2" style="display: none;">
                    <label>值：</label>
                    <input type="number" id="singleValue2" step="any" required>
                </span>
            </div>
            
            <button id="exportButton" onclick="exportData()">导出CSV</button>
            <div id="exportResult"></div>
        </div>
        
        <div class="status-bar" id="statusBar">
            就绪 | 等待输入...
        </div>
    </div>

    <script>
        // =================================================================
        // !! 重要配置 !!
        // 请将下面的地址替换为您的真实函数URL
        // =================================================================
        const API_BASE_URL = 'https://water-func-iqweupkgxi.cn-shanghai.fcapp.run'; 
        // 例如: 'https://water-func-iqweupkgxi.cn-shanghai.fcapp.run'
        // =================================================================

        const statusBar = document.getElementById('statusBar');
        const calculateButton = document.getElementById('calculateButton');
        let lastCalculationData = null; // 存储最后一次计算的数据

        function updateStatus(message, isError = false) {
            statusBar.textContent = message;
            statusBar.style.color = isError ? '#ff0000' : '#000080';
        }
        
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        document.getElementById('calculateForm').addEventListener('submit', function(e) {
            // 1. 阻止表单的默认提交行为
            e.preventDefault();
            
            const resultDiv = document.getElementById('calculateResult');
            resultDiv.innerHTML = ''; // 清空上次结果
            updateStatus('正在计算...');
            calculateButton.disabled = true; // 禁用按钮防止重复点击

            // 2. 收集表单数据
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // 3. 使用 Fetch API 发送异步 POST 请求
            fetch(`${API_BASE_URL}/calculate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data) // 将JS对象转为JSON字符串
            })
            .then(response => {
                // 4. 处理HTTP响应
                if (!response.ok) { // 如果状态码不是 2xx (如 404, 500)
                    // 尝试解析错误体，如果失败则给一个通用错误
                    return response.json().then(err => { 
                        throw new Error(err.error || `服务器错误 (状态: ${response.status})`) 
                    });
                }
                return response.json(); // 解析成功的响应体
            })
            .then(responseData => {
                // 5. 处理从响应体中解析出的JSON数据
                // API返回格式: [status_code, headers, body_string]
                let data;
                if (Array.isArray(responseData)) {
                    // 如果是数组格式，解析第三个元素(body字符串)
                    const bodyString = responseData[2];
                    data = JSON.parse(bodyString);
                } else {
                    // 如果是直接的对象格式
                    data = responseData;
                }
                
                if (data.success) {
                    const props = data.properties;
                    // 动态生成结果HTML，而不是写死属性
                    let html = '<div class="result"><h3>水物性参数</h3><div class="properties-grid">';
                    
                    // 属性映射：英文名 -> 中文名、单位、转换函数
                    const propertyMap = {
                        temperature: { name: '温度', unit: '°C', convert: (v) => v - 273.15 },
                        pressure: { name: '压力', unit: 'MPa', convert: (v) => v / 1000000 },
                        enthalpy: { name: '焓', unit: 'kJ/kg', convert: (v) => v / 1000 },
                        entropy: { name: '熵', unit: 'kJ/(kg·K)', convert: (v) => v / 1000 },
                        density: { name: '密度', unit: 'kg/m³', convert: (v) => v },
                        quality: { name: '热力干度', unit: '', convert: (v) => v },
                        specific_heat: { name: '比热容', unit: 'kJ/(kg·K)', convert: (v) => v / 1000 },
                        thermal_conductivity: { name: '导热系数', unit: 'W/(m·K)', convert: (v) => v },
                        viscosity: { name: '动力粘度', unit: 'Pa·s', convert: (v) => v },
                        surface_tension: { name: '表面张力', unit: 'N/m', convert: (v) => v },
                        speed_of_sound: { name: '声速', unit: 'm/s', convert: (v) => v },
                        // 饱和数据
                        saturation_data: {
                            tsat: { name: '饱和温度', unit: '°C', convert: (v) => v - 273.15 },
                            psat: { name: '饱和压力', unit: 'MPa', convert: (v) => v / 1000000 },
                            hf: { name: '饱和液体焓', unit: 'kJ/kg', convert: (v) => v / 1000 },
                            hg: { name: '饱和蒸汽焓', unit: 'kJ/kg', convert: (v) => v / 1000 },
                            hfg: { name: '汽化潜热', unit: 'kJ/kg', convert: (v) => v / 1000 }
                        }
                    };
                    
                    // 处理主要属性
                    for (const propKey in props) {
                        if (Object.prototype.hasOwnProperty.call(props, propKey) && propKey !== 'saturation_data') {
                            const value = props[propKey];
                            const propInfo = propertyMap[propKey];
                            
                            if (propInfo) {
                                const convertedValue = propInfo.convert(value);
                                const displayValue = typeof convertedValue === 'number' ? 
                                    convertedValue.toPrecision(8) : convertedValue;
                                const unitText = propInfo.unit ? ` ${propInfo.unit}` : '';
                                
                                html += `<div class="property">
                                            <div class="property-name">${propInfo.name}</div>
                                            <div class="property-value">${displayValue}${unitText}</div>
                                         </div>`;
                            }
                        }
                    }
                    
                    // 处理饱和数据
                    if (props.saturation_data) {
                        html += '<div class="property" style="grid-column: 1 / -1;"><div class="property-name">饱和数据</div></div>';
                        for (const satKey in props.saturation_data) {
                            if (Object.prototype.hasOwnProperty.call(props.saturation_data, satKey)) {
                                const value = props.saturation_data[satKey];
                                const satInfo = propertyMap.saturation_data[satKey];
                                
                                if (satInfo) {
                                    const convertedValue = satInfo.convert(value);
                                    const displayValue = typeof convertedValue === 'number' ? 
                                        convertedValue.toPrecision(8) : convertedValue;
                                    const unitText = satInfo.unit ? ` ${satInfo.unit}` : '';
                                    
                                    html += `<div class="property">
                                                <div class="property-name">${satInfo.name}</div>
                                                <div class="property-value">${displayValue}${unitText}</div>
                                             </div>`;
                                }
                            }
                        }
                    }
                    
                    html += '</div></div>';
                    resultDiv.innerHTML = html;
                    updateStatus('计算完成');
                    
                    // 保存计算结果用于导出
                    lastCalculationData = {
                        inputs: data,
                        properties: props,
                        timestamp: new Date().toISOString()
                    };
                } else {
                    // 如果 success: false
                    throw new Error(data.error || '计算失败');
                }
            })
            .catch(error => {
                // 6. 统一捕获并显示任何环节发生的错误
                let errorMessage = error.message;
                
                // 如果是CORS或网络错误，提供更友好的提示
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = '无法连接到服务器。请检查：<br>1. API服务是否正常运行<br>2. 网络连接是否正常<br>3. 是否存在CORS跨域问题';
                } else if (error.message.includes('CORS')) {
                    errorMessage = '跨域请求被拒绝。请联系服务器管理员配置CORS策略。';
                }
                
                resultDiv.innerHTML = `<div class="result error"><h3>错误</h3><p>${errorMessage}</p></div>`;
                updateStatus(`错误: ${error.message}`, true);
            })
            .finally(() => {
                // 7. 无论成功或失败，最后都重新启用按钮
                calculateButton.disabled = false;
            });
        });
        
        // 切换范围输入显示
        function toggleRangeInputs(paramNum) {
            const steps = document.getElementById(`steps${paramNum}`).value;
            const rangeSpan = document.getElementById(`range${paramNum}`);
            const singleSpan = document.getElementById(`single${paramNum}`);
            
            if (parseInt(steps) === 1) {
                rangeSpan.style.display = 'none';
                singleSpan.style.display = 'inline';
            } else {
                rangeSpan.style.display = 'inline';
                singleSpan.style.display = 'none';
            }
        }
        
        // 页面加载时初始化显示状态
        document.addEventListener('DOMContentLoaded', function() {
            toggleRangeInputs(1);
            toggleRangeInputs(2);
        });
        
        // 导出数据函数
        async function exportData() {
            const exportResult = document.getElementById('exportResult');
            const exportButton = document.getElementById('exportButton');
            
            // 收集表单数据
            const param1 = document.getElementById('param1').value;
            const steps1 = document.getElementById('steps1').value;
            const param2 = document.getElementById('param2').value;
            const steps2 = document.getElementById('steps2').value;
            
            // 根据步数决定是否需要起始值和结束值
            let start1, end1, start2, end2;
            
            if (parseInt(steps1) === 1) {
                start1 = document.getElementById('singleValue1').value;
                if (!start1) {
                    exportResult.innerHTML = `<div class="result error"><h3>错误</h3><p>请填写参数1的值</p></div>`;
                    return;
                }
                end1 = start1; // 步数为1时，结束值等于起始值
            } else {
                start1 = document.getElementById('start1').value;
                end1 = document.getElementById('end1').value;
                if (!start1 || !end1) {
                    exportResult.innerHTML = `<div class="result error"><h3>错误</h3><p>请填写参数1的起始值和结束值</p></div>`;
                    return;
                }
            }
            
            if (parseInt(steps2) === 1) {
                start2 = document.getElementById('singleValue2').value;
                if (!start2) {
                    exportResult.innerHTML = `<div class="result error"><h3>错误</h3><p>请填写参数2的值</p></div>`;
                    return;
                }
                end2 = start2; // 步数为1时，结束值等于起始值
            } else {
                start2 = document.getElementById('start2').value;
                end2 = document.getElementById('end2').value;
                if (!start2 || !end2) {
                    exportResult.innerHTML = `<div class="result error"><h3>错误</h3><p>请填写参数2的起始值和结束值</p></div>`;
                    return;
                }
            }
            
            exportButton.disabled = true;
            updateStatus('正在生成CSV文件...');
            
            try {
                const requestData = {
                    param1: param1,
                    start1: parseFloat(start1),
                    end1: parseFloat(end1),
                    steps1: parseInt(steps1),
                    param2: param2,
                    start2: parseFloat(start2),
                    end2: parseFloat(end2),
                    steps2: parseInt(steps2)
                };
                
                const response = await fetch(`${API_BASE_URL}/export_csv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `服务器错误 (状态: ${response.status})`);
                }
                
                // 处理CSV文件下载
                const contentDisposition = response.headers.get('Content-Disposition');
                const filename = contentDisposition ? 
                    contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                    'water_properties.csv';
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // 计算总数据量
                const totalPoints = parseInt(steps1) * parseInt(steps2);
                exportResult.innerHTML = `<div class="result"><h3>导出成功</h3><p>已生成 ${totalPoints} 个数据点的CSV文件</p></div>`;
                updateStatus('导出完成');
                
            } catch (error) {
                exportResult.innerHTML = `<div class="result error"><h3>导出失败</h3><p>${error.message}</p></div>`;
                updateStatus(`导出失败: ${error.message}`, true);
            } finally {
                exportButton.disabled = false;
            }
        }
        
          
    </script>
</body>
</html>